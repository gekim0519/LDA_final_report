---
title: "logitudinal_final_proj"
author: "Lynette Pan"
date: "12/3/2018"
output: github_document
---

#Final Project: Smoking in the Framingham Heart Study


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(janitor)
library(mice)
library(gee)
library(lme4)

frmgham = 
  read.csv2("frmgham2.csv", sep = ",", na.strings=c("","NA")) %>% 
  clean_names() %>% select(cursmoke, everything()) %>% 
  mutate(sex = as.factor(sex),
         bpmeds = as.factor(bpmeds),
         educ = as.factor(educ),
         diabetes = as.factor(diabetes),
         prevap = as.factor(prevap),
         prevchd = as.factor(prevchd),
         prevmi = as.factor(prevmi),
         prevstrk = as.factor(prevstrk),
         prevhyp = as.factor(prevhyp),
         sysbp = as.numeric(levels(sysbp))[sysbp],
         diabp = as.numeric(as.character(diabp)),
         bmi = as.numeric(as.character(bmi))) %>% 
  as.tibble()

## created age category variable (age_ctg)
frmgham =
  frmgham %>% 
  mutate(
      age_ctg = case_when(
      age < 35 ~ "35-",  
      age %in% 35:44 ~ "35-44",
      age %in% 45:54 ~ "45-54",
      age %in% 55:64 ~ "55-64",
      age %in% 65:74 ~ "65-74",
      age >= 75 ~ "75+"
    ),
    age_ctg = fct_relevel(age_ctg, "35-")) 

## created sysbp category variable (sysbp_ctg)
### According to the new guideline from american heart association
### https://www.ahajournals.org/doi/10.1161/HYP.0000000000000065
frmgham =
  frmgham %>% 
  mutate(
      sysbp_ctg = case_when(
      sysbp < 120 ~ "normal",  
      (sysbp >= 120 & sysbp < 130) ~ "elevated",
      (sysbp >= 130 & sysbp < 140) ~ "stage1",
      (sysbp >= 140 & sysbp <= 180) ~ "stage2",
      sysbp > 180 ~ "crisis"
    ),
    sysbp_ctg = fct_relevel(sysbp_ctg, "normal")) 

## created sysbp category variable (diabp_ctg)
### According to the new guideline from american heart association
### https://www.ahajournals.org/doi/10.1161/HYP.0000000000000065
frmgham =
  frmgham %>% 
  mutate(
      diabp_ctg = case_when(
      diabp < 80 ~ "normal and elevated",  
      (diabp >= 80 & diabp < 90) ~ "stage1",
      (diabp >= 90 & diabp <= 120 ) ~ "stage2",
      diabp > 120 ~ "crisis"
      ),
    diabp_ctg = fct_relevel(diabp_ctg, "normal and elevated")) 

```

# Descriptive statistics
```{r}
#descriptive statistics for the data

summary(frmgham)
```



#missing values
```{r}
# frmgham %>% 
#   group_by(period) %>% 
#   summarize(sum_na_period = sum(is.na(period)))
# 
# d1 = frmgham %>% 
#   group_by(randid) %>% 
#   summarize(n = n())
# table(d1$n)
# # 447 patients have only one obs
# # 781 patients have only two obs
# # 3206 patients have all three obs
# 
# number.subjects <- 
#   frmgham  %>% 
#   select(randid) %>% 
#   distinct() %>% 
#   unlist() %>%
#   length()
# 
# number.subjects
# 
# # missing data pattern by variables
# 
# sort(sapply(frmgham, function(x) { sum(is.na(x)) }), decreasing=TRUE)

```

# Impute missing values using MICE package
```{r}
load("frmgham_complete.RData")
# # frmgham_temp <- mice(frmgham,m=1, method='cart', printFlag=FALSE,seed = 1)
# # frmgham
# # summary(frmgham_temp)
# # frmgham_complete <- complete(frmgham_temp)
# #save(frmgham_complete, file = "frmgham_complete.RData")
# frmgham_complete =
#   frmgham_complete %>% 
#   mutate(
#       age_ctg = case_when(
#       age < 35 ~ "35-",  
#       age %in% 35:44 ~ "35-44",
#       age %in% 45:54 ~ "45-54",
#       age %in% 55:64 ~ "55-64",
#       age %in% 65:74 ~ "65-74",
#       age >= 75 ~ "75+"
#     )) 
# 
# sort(sapply(frmgham_complete, function(x) { sum(is.na(x)) }), decreasing=TRUE)

```


* The output tells us that 2243 samples are complete, 7077 samples miss both hdlc and ldlc, 4 samples miss only the glucose value and so on.


* there are 447 patients who have only one obs; there are 781 patients who have only two obs and 3206 patients have all three obs. In total, there are 4434 patients in the study.

##1. Target question:
1) Is there a relationship between age and smoking status?  Does this relationship differ by sex? 

```{r}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(janitor)
library(mice)
library(gee)


frmgham = 
  read.csv2("frmgham2.csv", sep = ",", na.strings=c("","NA")) %>% 
  clean_names() %>% select(cursmoke, everything()) %>% 
  mutate(sex = as.factor(sex),
         bpmeds = as.factor(bpmeds),
         educ = as.factor(educ),
         diabetes = as.factor(diabetes),
         prevap = as.factor(prevap),
         prevchd = as.factor(prevchd),
         prevmi = as.factor(prevmi),
         prevstrk = as.factor(prevstrk),
         prevhyp = as.factor(prevhyp),
         sysbp = as.numeric(levels(sysbp))[sysbp],
         diabp = as.numeric(as.character(diabp)),
         bmi = as.numeric(as.character(bmi))) %>% 
  as.tibble()

## created age category variable (age_ctg)
frmgham =
  frmgham %>% 
  mutate(
      age_ctg = case_when(
      age < 35 ~ "35-",  
      age %in% 35:44 ~ "35-44",
      age %in% 45:54 ~ "45-54",
      age %in% 55:64 ~ "55-64",
      age %in% 65:74 ~ "65-74",
      age >= 75 ~ "75+"
    ),
    age_ctg = fct_relevel(age_ctg, "35-")) 

## created sysbp category variable (sysbp_ctg)
### According to the new guideline from american heart association
### https://www.ahajournals.org/doi/10.1161/HYP.0000000000000065
frmgham =
  frmgham %>% 
  mutate(
      sysbp_ctg = case_when(
      sysbp < 120 ~ "normal",  
      (sysbp >= 120 & sysbp < 130) ~ "elevated",
      (sysbp >= 130 & sysbp < 140) ~ "stage1",
      (sysbp >= 140 & sysbp <= 180) ~ "stage2",
      sysbp > 180 ~ "crisis"
    ),
    sysbp_ctg = fct_relevel(sysbp_ctg, "normal")) 

## created sysbp category variable (diabp_ctg)
### According to the new guideline from american heart association
### https://www.ahajournals.org/doi/10.1161/HYP.0000000000000065
frmgham =
  frmgham %>% 
  mutate(
      diabp_ctg = case_when(
      diabp < 80 ~ "normal and elevated",  
      (diabp >= 80 & diabp < 90) ~ "stage1",
      (diabp >= 90 & diabp <= 120 ) ~ "stage2",
      diabp > 120 ~ "crisis"
      ),
    diabp_ctg = fct_relevel(diabp_ctg, "normal and elevated")) 
```

### cursmoke vs age_ctg without adjustment
```{r}
### cursmoke vs age_ctg : associated without adjustment 
frmgham %>% 
  select(randid, cursmoke, age_ctg) %>% 
  na.omit() %>% 
  group_by(age_ctg) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n()) %>% 
  ggplot(aes(x = age_ctg, y = p_cursmoke)) + 
  geom_bar(stat = "identity") +
  labs(title = "Relationship between categorized age and smoking status",
       x = "Age",
       y = "Probability of current smoking")
```

## Finding confounders 
### age and cursmoke -- confounder: hdlc, ldlc


```{r}
age <-
  glmer(cursmoke ~ age + (1|randid),
      data = frmgham,
      family = binomial, 
      nAGQ = 0)

pot_conf <- names(frmgham)[-c(1:3, 5)]
pot_conf <-
  pot_conf[-c(grep("time", pot_conf))]

conf_det <- vector("list", length = length(pot_conf))
names(conf_det) <- pot_conf



for (conf in pot_conf) {

  data <- cbind(frmgham[,c("cursmoke", "age", "randid")], frmgham[,conf])
  formula <- paste("cursmoke","~","age + (1|randid) +", conf)
  try(fit_glmer <- glmer(formula,
      data = data,
      family = binomial,
      nAGQ = 0))

  result <- tibble(
    variable = c("age"),
    OR =
      exp(coef(summary(age))[2,1]),
    lower_CI =
      exp(coef(summary(age))[2,1] - 1.96*(coef(summary(age))[2,2])),
    upper_CI =
      exp(coef(summary(age))[2,1] + 1.96*(coef(summary(age))[2,2])),
    potconf_OR =
<<<<<<< HEAD
      exp(coef(summary(fit_gee))[2,1]),
=======
      exp(coef(summary(fit_glmer))[2,1]),
>>>>>>> 2261cd73fb11b5590b29978c2a5f67d3ed3af939
    confounder =
      if_else((potconf_OR >= lower_CI & potconf_OR <= upper_CI), FALSE, TRUE)
  )

  conf_det[[conf]] <- result
}

map(conf_det, knitr::kable, digits = 3)
```




## Finding modifier

```{r}
### by sex -- modified!
frmgham %>% 
  mutate(sex = ifelse(sex == 1, "male", "women")) %>%
  select(randid, cursmoke, age_ctg, sex) %>% 
  na.omit() %>% 
  group_by(age_ctg, sex) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n(),
            lower_CI = prop.test(sum(cursmoke), n())$conf.int[1],
            upper_CI = prop.test(sum(cursmoke), n())$conf.int[2]) %>%
  ggplot(aes(x = age_ctg, y = p_cursmoke, color = sex, group = sex)) +
  geom_errorbar(aes(ymin = lower_CI, ymax = upper_CI), width = .1) +
  geom_line() +
  labs(title = "Relationship between categorized age and smoking status by sex",
       x = "Age",
       y = "Probability of current smoking")


### by educ -- not modified except 35-

frmgham %>% 
  select(randid, cursmoke, age_ctg, educ) %>% 
  na.omit() %>% 
  group_by(age_ctg, educ) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n()) %>% 
  ggplot(aes(x = age_ctg, y = p_cursmoke, color = educ, group = educ)) + 
  geom_line() +
  geom_point() +
  labs(title = "Relationship between categorized age and smoking status by sex",
       x = "Age",
       y = "Probability of current smoking")

### by diabetes -- not modified 

frmgham %>% 
  select(randid, cursmoke, age_ctg, diabetes) %>% 
  na.omit() %>% 
  group_by(age_ctg, diabetes) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n()) %>% 
  ggplot(aes(x = age_ctg, y = p_cursmoke, color = diabetes, group = diabetes)) + 
  geom_line() +
  geom_point() +
  labs(title = "Relationship between categorized age and smoking status by sex",
       x = "Age",
       y = "Probability of current smoking")

### by prevap -- not modified 

frmgham %>% 
  select(randid, cursmoke, age_ctg, prevap) %>% 
  na.omit() %>% 
  group_by(age_ctg, prevap) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n()) %>% 
  ggplot(aes(x = age_ctg, y = p_cursmoke, color = prevap, group = prevap)) + 
  geom_line() +
  geom_point() +
  labs(title = "Relationship between categorized age and smoking status by sex",
       x = "Age",
       y = "Probability of current smoking")

### by prevchd -- not modified 

frmgham %>% 
  select(randid, cursmoke, age_ctg, prevchd) %>% 
  na.omit() %>% 
  group_by(age_ctg, prevchd) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n()) %>% 
  ggplot(aes(x = age_ctg, y = p_cursmoke, color = prevchd, group = prevchd)) + 
  geom_line() +
  geom_point() +
  labs(title = "Relationship between categorized age and smoking status by sex",
       x = "Age",
       y = "Probability of current smoking")

### by prevmi -- not modified 

frmgham %>% 
  select(randid, cursmoke, age_ctg, prevmi) %>% 
  na.omit() %>% 
  group_by(age_ctg, prevmi) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n(),
            lower_CI = prop.test(sum(cursmoke), n())$conf.int[1],
            upper_CI = prop.test(sum(cursmoke), n())$conf.int[2]) %>%
  ggplot(aes(x = age_ctg, y = p_cursmoke, color = prevmi, group = prevmi)) +
  geom_errorbar(aes(ymin = lower_CI, ymax = upper_CI), width = .1) +
  geom_line() +
  geom_point() +
  labs(title = "Relationship between categorized age and smoking status by sex",
       x = "Age",
       y = "Probability of current smoking")

### by prevstrk -- not modified 

frmgham %>% 
  select(randid, cursmoke, age_ctg, prevstrk) %>% 
  na.omit() %>% 
  group_by(age_ctg, prevstrk) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n(),
            lower_CI = prop.test(sum(cursmoke), n())$conf.int[1],
            upper_CI = prop.test(sum(cursmoke), n())$conf.int[2]) %>%
  ggplot(aes(x = age_ctg, y = p_cursmoke, color = prevstrk, group = prevstrk)) +
  geom_errorbar(aes(ymin = lower_CI, ymax = upper_CI), width = .1) +
  geom_line() +
  geom_point() +
  labs(title = "Relationship between categorized age and smoking status by sex",
       x = "Age",
       y = "Probability of current smoking")

### by prevhyp -- slightly modified 

frmgham %>% 
  select(randid, cursmoke, age_ctg, prevhyp) %>% 
  na.omit() %>% 
  group_by(age_ctg, prevhyp) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n(),
            lower_CI = prop.test(sum(cursmoke), n())$conf.int[1],
            upper_CI = prop.test(sum(cursmoke), n())$conf.int[2]) %>%
  ggplot(aes(x = age_ctg, y = p_cursmoke, color = prevhyp, group = prevhyp)) +
  geom_errorbar(aes(ymin = lower_CI, ymax = upper_CI), width = .1) + 
  geom_line() +
  geom_point() +
  labs(title = "Relationship between categorized age and smoking status by sex",
       x = "Age",
       y = "Probability of current smoking")
```

## Fit model using glmer
```{r}
#educ variable
##https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4939617/
  
cursmoke_age <-
  glmer(cursmoke ~ age*sex + educ + hdlc + ldlc + age*prevhyp + (1|randid), 
        data = frmgham, family = binomial, nAGQ = 0)

summary(cursmoke_age)

# changed model based on cigpday
cursmoke_age <-
  glmer(cursmoke ~ age*sex + educ + heartrte + hdlc + ldlc + age*prevhyp + (1|randid), 
        data = frmgham, family = binomial, nAGQ = 0)

summary(cursmoke_age)
```

```{r}
# cigpday
frmgham_smoker =
  frmgham %>% filter(cigpday != 0)

cigpday_age <-
  glmer(cigpday ~ age*sex + educ + heartrte + age*prevhyp + (1|randid), 
        data = frmgham_smoker, family = poisson, nAGQ = 0)

summary(cigpday_age)
```

(2) Is there a relationship between the number of cigarettes smoked per day and age?  Does this relationship differ by sex? 

While answering these questions, please account for any confounders that you have evidence may impact the relationship between age and sex with smoking.

```{r}
frmgham %>% 
  ggplot(., aes(x=age, y=cigpday)) +
    geom_jitter() + 
    geom_smooth(method = "loess") +
  ggtitle("Unadjusted relationship between the number of cigarettes smoked per day and age")
```

```{r}
frmgham_smoker  = frmgham %>%
filter(cigpday != 0) 

#summary stat 
frmgham_smoker %>%
  dplyr::select(cigpday, age, period) %>%
  pastecs::stat.desc() %>%
  round(digits = 3)

frmgham_smoker %>%
  distinct(randid) %>%
  nrow()
#2294 # of smokers

#missings in smokers
frmgham_smoker %>%
 group_by(period) %>%
   summarize(n = n(),
     missing = 2294 - n,
           sum_na_cigpday = sum(is.na(cigpday)))

frmgham_smoker %>%
 group_by(randid) %>%
 mutate(mean.cigpday = mean(cigpday)) %>%
 ungroup() %>%
 select(randid, mean.cigpday) %>%
 distinct() %>%
 ggplot(aes(x = mean.cigpday)) +
 geom_histogram(color="darkblue", fill="lightblue", aes(y=..density..)) +
 labs(x = "Average number of cigarettes smoked per day",
      y = "Density",
      title = "cigpday summary")


```


```{r spaghetti plot}
frmgham_smoker %>% 
  mutate(sex = ifelse(sex == 1, "male", "women")) %>%
  ggplot(aes(x = age, y = cigpday, group = randid, color = sex)) +
  geom_line(alpha = .5) 
```
Looking at the plot, we can consider random intercept model.

We see that most of the particpants are smoking 20 cigarettes per day.

```{r finding counfounders for m2}
# I will look into SYSBP DIABP TOTCHOL BMI DIABETES 
# based on https://tobaccocontrol.bmj.com/content/14/5/315

age <- glmer(cigpday ~ age + (1 | randid), 
      data = frmgham,
      family = poisson,
      nAGQ = 0)

pot_conf <- names(frmgham)[-c(2, 5, 8)]
pot_conf <-
  pot_conf[-c(grep("time", pot_conf))]

conf_det <- vector("list", length = length(pot_conf))
names(conf_det) <- pot_conf

conf_det <- vector("list", length = length(pot_conf))
names(conf_det) <- pot_conf

for (conf in pot_conf) {

  data <- cbind(frmgham[,c("cigpday", "age", "randid")], frmgham[,conf])
  formula <- paste("cigpday","~","age + (1|randid) +", conf)
  
  try(fit_glmer <- glmer(formula,
      data = data,
      family = poisson,
      nAGQ = 0))

  result <- tibble(
    variable = c("age"),
    OR =
      exp(coef(summary(age))[2,1]),
    lower_CI  =
      exp(coef(summary(age))[2,1] - 1.96*(coef(summary(age))[2,2])),
    upper_CI =
      exp(coef(summary(age))[2,1] + 1.96*(coef(summary(age))[2,2])),
    potconf_OR =
      exp(coef(summary(fit_glmer))[2,1]),
    confounder =
      if_else((potconf_OR >= lower_CI & potconf_OR <= upper_CI), FALSE, TRUE)
  )

  conf_det[[conf]] <- result
}

#map(conf_det, knitr::kable, digits = 3)
conf_det
```

```{r}
frmgham_smoker %>% 
  mutate(sex = ifelse(sex == 1, "male", "women")) %>%
  select(randid, cigpday, age_ctg, sex) %>% 
  na.omit() %>% 
  group_by(age_ctg, sex) %>% 
  summarise(cigpday_mean = mean(cigpday),
            se = sqrt(var(cigpday))) %>%
  ggplot(aes(x = age_ctg, y = cigpday_mean, color = sex, group = sex)) + 
  geom_line() +
  geom_errorbar(aes(ymin = cigpday_mean - se, ymax = cigpday_mean + se), width = .1) + 
  labs(title = "Relationship between categorized age and cigpday by sex",
       x = "Age",
       y = "mean number of cigarettes smoked per day")

# add errorbar

```


```{r backward selection}
cigpday.lmer1<- glmer(cigpday ~ age + sex + heartrte + prevchd + hdlc + prevap + (1 | randid), data = frmgham_smoker, family = poisson, nAGQ = 0)
summary(cigpday.lmer1)
# AIC   7873.592 
cigpday.lmer2<- glmer(cigpday ~ age + sex + heartrte + prevchd + hdlc + (1 | randid), data = frmgham_smoker, family = poisson, nAGQ = 0)
summary(cigpday.lmer2)
# AIC 7874.8
# remove prevchd
cigpday.lmer3<- glmer(cigpday ~ age + sex + heartrte + hdlc + (1 | randid), data = frmgham_smoker, family = poisson, nAGQ = 0)
summary(cigpday.lmer3)
# AIC 7872.8
#-0.002262
cigpday.lmer3<- glmer(cigpday ~ age + sex + heartrte + hdlc + prevchd + (1 | randid), data = frmgham_smoker, family = poisson, nAGQ = 0)
summary(cigpday.lmer3)

# tested interaction term with age
cigpday.lmer4<- glmer(cigpday ~ age + sex + heartrte + hdlc + age:sex + (1 | randid), data = frmgham_smoker, family = poisson, nAGQ = 0)
summary(cigpday.lmer4)
# AIC  7873.8
cigpday.lmer5<- glmer(cigpday ~ age + sex + heartrte + hdlc + age:heartrte + (1 | randid), data = frmgham_smoker, family = poisson, nAGQ = 0)
summary(cigpday.lmer5)
# decided with heartrte
# AIC   7870.3
```

I will try putting other variables in the model based on research papers. (educ, sex*age)
#https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4939617/
```{r model selection based on research}
cigpday.lmer6<- glmer(cigpday ~ age + sex + educ + heartrte + prevhyp + age*sex + age:prevhyp + (1 | randid), data = frmgham_smoker, family = poisson, nAGQ = 0)
summary(cigpday.lmer6)
# AIC 35492.2

cigpday.lmer7<- glmer(cigpday ~ age + sex + educ + heartrte + prevhyp + hdlc + age:sex + age:prevhyp + (1 | randid), data = frmgham_smoker, family = poisson, nAGQ = 0)
summary(cigpday.lmer7)
# AIC 7678.7
# need to include hdlc

##** FINAL MODEL **##
# removing prevhyp and age:prevhyp add age:heartrte
cigpday.lmer8<- glmer(cigpday ~ age + sex + educ + heartrte + hdlc + age:heartrte + age:sex + (1 | randid), data = frmgham_smoker, family = poisson, nAGQ = 0)
summary(cigpday.lmer8)
# AIC 7672.4 

##** FINAL MODEL **##
# removing educ
cigpday.lmer9<- glmer(cigpday ~ age + sex + heartrte + hdlc + age:heartrte + (1 | randid), data = frmgham_smoker, family = poisson, nAGQ = 0)
summary(cigpday.lmer9)
# AIC 7870.3

exp(0.0190057)
```
the var for random intercept; randid (Intercept) 0.3513 is low
test overspersion

```{r model assumption checking}
blmeco::dispersion_glmer(cigpday.lmer9)
# is between 0.75 and 1.4

qqnorm(ranef(cigpday.lmer9)$randid[,1])
qqline(ranef(cigpday.lmer9)$randid[,1])

plot(fitted(cigpday.lmer9), resid(cigpday.lmer9)) #residuals vs fitted
abline(h=0)

smoker_rmna <- frmgham_smoker %>%
  dplyr::select(randid, cigpday, age, sex, heartrte, hdlc) %>% drop_na()
smoker_rmna$fitted <- fitted(cigpday.lmer9)    

#fitted vs observed
plot(smoker_rmna$fitted, jitter(smoker_rmna$cigpday,0.1))
abline(0,1)

# overdispersion func 
# https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#overdispersion
overdisp_fun <- function(model) {
    rdf <- df.residual(model)
    rp <- residuals(model,type="pearson")
    Pearson.chisq <- sum(rp^2)
    prat <- Pearson.chisq/rdf
    pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
    c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}
overdisp_fun(cigpday.lmer9)
# tested the goodness of fit using Chi square test 
# null hypothesis is that our model is correctly specified
# p-val = 1 not reject, no overdispersion

cigpday.lmer10<- glmer(cigpday ~ age + sex + sex:age + (1 | randid), data = frmgham_smoker, family = poisson, nAGQ = 0)
summary(cigpday.lmer10)
#GLM for single time point 
fit.glm <- frmgham_smoker %>%
  group_by(randid) %>%
  summarise(min_age = min(age)) %>%
  left_join(frmgham_smoker, by = c("min_age" = "age", "randid" = "randid")) %>%
  glm(cigpday ~ min_age + sex + heartrte + hdlc + min_age*heartrte,
                   data = .,
                   family = 'poisson')
summary(fit.glm)
# Null deviance: 100.78  on 15  degrees of freedom
# overdispersion


```


#2.Target question:

Next you are interested in the relationship between certain health outcomes and smoking status. In particular you are interested in :


(1)The relationship between current smoking status and systolic blood pressure.
```{r}
frmgham %>% 
  ggplot(., aes(x=sysbp, y=cursmoke)) +
    geom_jitter() + 
    geom_smooth(method = "loess") + 
  ggtitle("Unadjusted relationship between current smoking status and diastolic blood pressure")

#https://www.ncbi.nlm.nih.gov/pubmed/7790985
#From the research paper above, diastolic blood pressure and hypertension are potential confounders.

#center the variables and find the confounder
frmgham$diabp_c = frmgham$diabp-mean(frmgham$diabp)
frmgham$sysbp_c = frmgham$sysbp-mean(frmgham$sysbp)

sysbp <- 
  glmer(cursmoke ~ sysbp_c + (1|randid), 
      data = frmgham, 
      family = binomial)

sysbp_diabp <- 
  glmer(cursmoke ~ sysbp_c + diabp_c + (1|randid), 
      data = frmgham, 
      family = binomial)

sysbp_prevhyp <- 
  glmer(cursmoke ~ sysbp_c + prevhyp + (1|randid), 
      data = frmgham, 
      family = binomial)

sysbp_hyperten <- 
  glmer(cursmoke ~ sysbp_c + hyperten+ (1|randid), 
      data = frmgham, 
      family = binomial)

tibble(
    variable = c("diabp", "prevhyp", "hyperten"),
    OR = 
      exp(coef(summary(sysbp))[2,1]),
    lower_CI  = 
      exp(coef(summary(sysbp))[2,1] - 1.96*(coef(summary(sysbp))[2,4])),
    upper_CI = 
      exp(coef(summary(sysbp))[2,1] + 1.96*(coef(summary(sysbp))[2,4])),
    conf_OR =
      c(exp(coef(summary(sysbp_diabp))[2,1]),
        exp(coef(summary(sysbp_prevhyp))[2,1]),
        exp(coef(summary(sysbp_hyperten))[2,1])),
    confounder =
      if_else((conf_OR >= lower_CI & conf_OR <= upper_CI), FALSE, TRUE)
  )

smoke_diabp = glmer(cursmoke ~ diabp_c + sysbp_c + prevhyp + hyperten+ (1|randid), 
      data = frmgham, 
      family = binomial)
summary(smoke_diabp)
```

(2)The relationship between current smoking status and diastolic blood pressure.
```{r}
diabp <- 
  gee(cursmoke ~ diabp, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

diabp_sysbp <- 
  gee(cursmoke ~ diabp + sysbp, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

diabp_prevhyp <- 
  gee(cursmoke ~ diabp + prevhyp, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

diabp_hyperten <- 
  gee(cursmoke ~ diabp + hyperten, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

tibble(
    variable = c("sysbp", "prevhyp", "hyperten"),
    OR = 
      exp(coef(summary(diabp))[2,1]),
    lower_CI  = 
      exp(coef(summary(diabp))[2,1] - 1.96*(coef(summary(diabp))[2,4])),
    upper_CI = 
      exp(coef(summary(diabp))[2,1] + 1.96*(coef(summary(diabp))[2,4])),
    conf_OR =
      c(exp(coef(summary(diabp_sysbp))[2,1]),
        exp(coef(summary(diabp_prevhyp))[2,1]),
        exp(coef(summary(diabp_hyperten))[2,1])),
    confounder =
      if_else((conf_OR >= lower_CI & conf_OR <= upper_CI), FALSE, TRUE)
  )

smoke_diabp = gee(cursmoke ~ diabp + sysbp + prevhyp + hyperten, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))
summary(smoke_diabp)

#confounders: sysbp, prevhyp, hyperten
```

From the table above, we found "sysbp", "prevhyp" and "hyperten" are confounders. After adding the confounders, the final model is shown above. For a one-unit increase in the diastolic blood pressure, the expected change in log odds is 0.009, adjusting for systolic blood pressure, prevalent hypertensive and hypertensive.


---

(3)The relationship between current smoking status and serum total cholesterol. Again, while answering these questions, please account for any confounders that you have evidence may impact these relationships. 


```{r}
frmgham %>% 
  ggplot(., aes(x=totchol, y=cursmoke)) +
    geom_jitter() + 
    geom_smooth(method = "loess") +ggtitle("Unadjusted relationship between current smoking status and serum total cholesterol")


#https://medlineplus.gov/cholesterollevelswhatyouneedtoknow.html
#categorized totchol based on link above

frmgham=frmgham %>% 
  mutate(totchol_ctg= ifelse(age<=19 & totchol<170,0,
                             ifelse(age>19&totchol %in% c(125, 200), 0,1)))
table(frmgham$totchol_ctg)
# 124 normal total chol 
# 11503 abnormal total chol
```

## Finding confounders


```{r}

frmgham= frmgham %>% 
  mutate(bmi=as.numeric(as.character(bmi))) %>% 
  mutate(bmi_cat = ifelse(bmi<18.5,0,ifelse(bmi %in% c(18.5,24.9), 1, ifelse(bmi %in% c(25, 29.9),2, 3))))

totchol <- 
  gee(cursmoke ~ totchol, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))
pot_conf <- names(frmgham)[-c(1,2,4)]
pot_conf <- pot_conf[-c(grep("time", pot_conf), grep("death", pot_conf))]

conf_det <- vector("list", length = length(pot_conf))
names(conf_det) <- pot_conf



for (conf in pot_conf) {

 data <- cbind(frmgham[,c("cursmoke", "totchol")], frmgham[,conf])
 try(fit_gee <- gee(cursmoke ~ .,
     data = data,
     id = frmgham$randid,
     family = binomial,
     corstr = ("unstructured")))

 result <- tibble(
   variable = c("totchol"),
   OR =
     exp(coef(summary(totchol))[2,1]),
   lower_CI  =
     exp(coef(summary(totchol))[2,1] - 1.96*(coef(summary(totchol))[2,4])),
   upper_CI =
     exp(coef(summary(totchol))[2,1] + 1.96*(coef(summary(totchol))[2,4])),
   potconf_OR =
     exp(coef(summary(fit_gee))[2,1]),
   confounder =
     if_else((potconf_OR >= lower_CI & potconf_OR <= upper_CI), FALSE, TRUE)
 )

 conf_det[[conf]] <- result
}

map(conf_det, knitr::kable, digits = 3)
```


(1) age


```{r}


frmgham%>% 
  select(randid,totchol_ctg, age_ctg, cursmoke) %>% 
  na.omit() %>% 
  group_by(totchol_ctg,age_ctg) %>% 
  dplyr::summarise(percent.currentsmoke = sum(cursmoke)/n(),
                   n = n())
frmgham %>%
  select(randid,totchol_ctg, age_ctg, cursmoke) %>% 
  na.omit() %>% 
  group_by(totchol_ctg,age_ctg) %>%
  summarise(num.currentsmoke = sum(cursmoke)) %>% 
  ggplot(., aes(as.factor(totchol_ctg),num.currentsmoke)) +
    geom_bar(stat = "identity")+
  facet_wrap(~age_ctg)

```

(2)hdlc

```{r}
frmgham%>% 
  select(randid,totchol_ctg, hdlc, cursmoke) %>% 
  mutate(hdlc_ctg = cut(hdlc,breaks=c(-Inf, 40, 60, Inf), labels = c("Low", "Normal","Good"))) %>% 
  na.omit() %>% 
  group_by(totchol_ctg,hdlc_ctg) %>% 
  dplyr::summarise(percent.currentsmoke = sum(cursmoke)/n(),
                   n = n())

frmgham %>%
  select(randid,totchol_ctg, hdlc, cursmoke) %>% 
  mutate(hdlc_ctg = cut(hdlc,breaks=c(-Inf, 40, 60, Inf), labels = c("Low", "Normal","Good"))) %>% 
  na.omit() %>%  
  group_by(totchol_ctg,hdlc_ctg) %>%
  summarise(num.currentsmoke = sum(cursmoke)) %>% 
  ggplot(., aes(as.factor(totchol_ctg),num.currentsmoke)) +
    geom_bar(stat = "identity")+
  facet_wrap(~hdlc_ctg)
```


(3)ldlc

```{r}
frmgham%>% 
  select(randid,totchol_ctg, ldlc, cursmoke) %>% 
  mutate(ldlc_ctg = ifelse(ldlc>=130, "High","Ideal")) %>% 
  na.omit() %>% 
  group_by(totchol_ctg,ldlc_ctg) %>% 
  dplyr::summarise(percent.currentsmoke = sum(cursmoke)/n(),
                   n = n())


frmgham %>%
  select(randid,totchol_ctg, ldlc, cursmoke) %>% 
  mutate(ldlc_ctg = ifelse(ldlc>=130, "High","Ideal")) %>% 
  na.omit()  %>%  
  group_by(totchol_ctg,ldlc_ctg) %>%
  summarise(num.currentsmoke = sum(cursmoke)) %>% 
  ggplot(., aes(as.factor(totchol_ctg),num.currentsmoke)) +
    geom_bar(stat = "identity")+
  facet_wrap(~ldlc_ctg)
```

From the table above, we found age, ldlc and hdlc are confounders. 

## model fitting


```{r}
library(lme4)
cor(frmgham[,c("totchol", "age", "hdlc", "ldlc")],use = "pairwise.complete.obs")
m1 = glmer(cursmoke ~ totchol+ age+ hdlc+ldlc+(1|randid),
      data = frmgham, nAGQ=0,
      family = binomial(link=logit))
summary(m1)
se <- sqrt(diag(vcov(m1)))
# table of estimates with 95% CI
(tab <- cbind(Est = fixef(m1), LL = fixef(m1) - 1.96 * se, UL = fixef(m1) + 1.96 *
    se))
exp(tab)
m2 = glmer(cursmoke ~ totchol*age+ hdlc+age*ldlc+(1|randid),
      data = frmgham, nAGQ=0,
      family = binomial(link=logit))
summary(m2)
```



