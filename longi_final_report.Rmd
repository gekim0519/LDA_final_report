---
title: "logitudinal_final_proj"
author: "Lynette Pan"
date: "12/3/2018"
output: pdf_document
---

#Final Project: Smoking in the Framingham Heart Study


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(janitor)
library(mice)
library(gee)

frmgham = 
  read.csv2("frmgham2.csv", sep = ",", na.strings=c("","NA")) %>% 
  clean_names() %>% select(cursmoke, everything()) %>% 
  mutate(sex = as.factor(sex),
         bpmeds = as.factor(bpmeds),
         educ = as.factor(educ),
         diabetes = as.factor(diabetes),
         prevap = as.factor(prevap),
         prevchd = as.factor(prevchd),
         prevmi = as.factor(prevmi),
         prevstrk = as.factor(prevstrk),
         prevhyp = as.factor(prevhyp),
         sysbp = as.numeric(levels(sysbp))[sysbp],
         diabp = as.numeric(as.character(diabp)),
         bmi = as.numeric(as.character(bmi))) %>% 
  as.tibble()

## created age category variable (age_ctg)
frmgham =
  frmgham %>% 
  mutate(
      age_ctg = case_when(
      age < 35 ~ "35-",  
      age %in% 35:44 ~ "35-44",
      age %in% 45:54 ~ "45-54",
      age %in% 55:64 ~ "55-64",
      age %in% 65:74 ~ "65-74",
      age >= 75 ~ "75+"
    ),
    age_ctg = fct_relevel(age_ctg, "35-")) 

## created sysbp category variable (sysbp_ctg)
### According to the new guideline from american heart association
### https://www.ahajournals.org/doi/10.1161/HYP.0000000000000065
frmgham =
  frmgham %>% 
  mutate(
      sysbp_ctg = case_when(
      sysbp < 120 ~ "normal",  
      (sysbp >= 120 & sysbp < 130) ~ "elevated",
      (sysbp >= 130 & sysbp < 140) ~ "stage1",
      (sysbp >= 140 & sysbp <= 180) ~ "stage2",
      sysbp > 180 ~ "crisis"
    ),
    sysbp_ctg = fct_relevel(sysbp_ctg, "normal")) 

## created sysbp category variable (diabp_ctg)
### According to the new guideline from american heart association
### https://www.ahajournals.org/doi/10.1161/HYP.0000000000000065
frmgham =
  frmgham %>% 
  mutate(
      diabp_ctg = case_when(
      diabp < 80 ~ "normal and elevated",  
      (diabp >= 80 & diabp < 90) ~ "stage1",
      (diabp >= 90 & diabp <= 120 ) ~ "stage2",
      diabp > 120 ~ "crisis"
      ),
    diabp_ctg = fct_relevel(diabp_ctg, "normal and elevated")) 
```


#missing values
```{r}
frmgham %>% 
  group_by(period) %>% 
  summarize(sum_na_period = sum(is.na(period)))

d1 = frmgham %>% 
  group_by(randid) %>% 
  summarize(n = n())
table(d1$n)
# 447 patients have only one obs
# 781 patients have only two obs
# 3206 patients have all three obs

number.subjects <- 
  frmgham  %>% 
  select(randid) %>% 
  distinct() %>% 
  unlist() %>%
  length()

number.subjects

# missing data pattern by variables

sort(sapply(frmgham, function(x) { sum(is.na(x)) }), decreasing=TRUE)

```

# Impute missing values using MICE package
```{r}
load("frmgham_complete.RData")
# frmgham_temp <- mice(frmgham,m=1, method='cart', printFlag=FALSE,seed = 1)
# frmgham
# summary(frmgham_temp)
# frmgham_complete <- complete(frmgham_temp)
#save(frmgham_complete, file = "frmgham_complete.RData")
frmgham_complete =
  frmgham_complete %>% 
  mutate(
      age_ctg = case_when(
      age < 35 ~ "35-",  
      age %in% 35:44 ~ "35-44",
      age %in% 45:54 ~ "45-54",
      age %in% 55:64 ~ "55-64",
      age %in% 65:74 ~ "65-74",
      age >= 75 ~ "75+"
    )) 

sort(sapply(frmgham_complete, function(x) { sum(is.na(x)) }), decreasing=TRUE)

```


* The output tells us that 2243 samples are complete, 7077 samples miss both hdlc and ldlc, 4 samples miss only the glucose value and so on.


* there are 447 patients who have only one obs; there are 781 patients who have only two obs and 3206 patients have all three obs. In total, there are 4434 patients in the study.

##1. Target question:
1) Is there a relationship between age and smoking status?  Does this relationship differ by sex? 

* In general, an increase in age seems to results in a decrease in current smoking status. However, the age where it has the highest probability of being a smoker is around 40.



```{r}
frmgham %>% 
  ggplot(., aes(x=age, y=cursmoke)) +
    geom_jitter() + 
    geom_smooth(method = "loess") +ggtitle("Unadjusted relationship between age and smoking status")
```


```{r}
frmgham %>% 
  mutate(sex=ifelse(sex==1, "male","women")) %>% 
  ggplot(., aes(x=age, y=cursmoke)) +
    geom_jitter() + 
    geom_smooth(method = "loess") +
  facet_grid(~sex)+
  ggtitle("Relationship between age and smoking status by gender")
```
* In general, an increase in age seems to results in a decrease in current smoking status for both gender group.

### cursmoke vs age_ctg 
```{r}
frmgham %>% 
  select(randid, cursmoke, age_ctg) %>% 
  na.omit() %>% 
  group_by(age_ctg) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n()) %>% 
  ggplot(aes(x = age_ctg, y = p_cursmoke)) + 
  geom_bar(stat = "identity") +
  labs(title = "Relationship between categorized age and smoking status",
       x = "Age",
       y = "Probability of current smoking")
```

### cursmoke vs age_ctg by sex 
```{r}
frmgham %>% 
  mutate(sex = ifelse(sex == 1, "male", "women")) %>%
  select(randid, cursmoke, age_ctg, sex) %>% 
  na.omit() %>% 
  group_by(age_ctg, sex) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n()) %>% 
  ggplot(aes(x = age_ctg, y = p_cursmoke, color = sex, group = sex)) + 
  geom_line() +
  geom_point() +
  labs(title = "Relationship between categorized age and smoking status by sex",
       x = "Age",
       y = "Probability of current smoking")
```

## Finding confounders
### sex and cursmoke -- confounder: hdlc, ldlc
```{r}
sex <- 
  gee(cursmoke ~ sex, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))
```

####sysbp
```{r}
sex_sysbp <- 
  gee(cursmoke ~ sex + sysbp, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

tibble(
    variable = c("sex2"),
    OR = 
      exp(coef(summary(sex))[2,1]),
    lower_CI  = 
      exp(coef(summary(sex))[2,1] - 1.96*(coef(summary(sex))[2,4])),
    upper_CI = 
      exp(coef(summary(sex))[2,1] + 1.96*(coef(summary(sex))[2,4])),
    sysbp_OR =
      exp(coef(summary(sex_sysbp))[2,1]),
    confounder =
      if_else((sysbp_OR >= lower_CI & sysbp_OR <= upper_CI), FALSE, TRUE)
  ) %>% 
  knitr::kable(digits = 3)
```
sysbp_ctg is not a confounder since inferences for odds ratios of current smoking by sex was not changed by sysbp_ctg at the significance level 0.05.  

####diabp
```{r}
sex_diabp <- 
  gee(cursmoke ~ sex + diabp, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

tibble(
    variable = c("sex2"),
    OR = 
      exp(coef(summary(sex))[2,1]),
    lower_CI  = 
      exp(coef(summary(sex))[2,1] - 1.96*(coef(summary(sex))[2,4])),
    upper_CI = 
      exp(coef(summary(sex))[2,1] + 1.96*(coef(summary(sex))[2,4])),
    diabp_OR =
      exp(coef(summary(sex_diabp))[2,1]),
    confounder =
      if_else((diabp_OR >= lower_CI & diabp_OR <= upper_CI), FALSE, TRUE)
  ) %>% 
  knitr::kable(digits = 3)
```
diabp is not a confounder since inferences for odds ratios of current smoking by sex was not changed by diabp at the significance level 0.05.


####bpmeds
```{r}
sex_bpmeds <- 
  gee(cursmoke ~ sex + bpmeds, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

tibble(
    variable = c("sex2"),
    OR = 
      exp(coef(summary(sex))[2,1]),
    lower_CI  = 
      exp(coef(summary(sex))[2,1] - 1.96*(coef(summary(sex))[2,4])),
    upper_CI = 
      exp(coef(summary(sex))[2,1] + 1.96*(coef(summary(sex))[2,4])),
    bpmeds_OR =
      exp(coef(summary(sex_bpmeds))[2,1]),
    confounder =
      if_else((bpmeds_OR >= lower_CI & bpmeds_OR <= upper_CI), FALSE, TRUE)
  ) %>% 
  knitr::kable(digits = 3)
```
bpmeds is not a confounder since inferences for odds ratios of current smoking by sex was not changed by bpmeds at the significance level 0.05.

####educ
```{r}
sex_educ <- 
  gee(cursmoke ~ sex + educ, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

tibble(
    variable = c("sex2"),
    OR = 
      exp(coef(summary(sex))[2,1]),
    lower_CI  = 
      exp(coef(summary(sex))[2,1] - 1.96*(coef(summary(sex))[2,4])),
    upper_CI = 
      exp(coef(summary(sex))[2,1] + 1.96*(coef(summary(sex))[2,4])),
    educ_OR =
      exp(coef(summary(sex_educ))[2,1]),
    confounder =
      if_else((educ_OR >= lower_CI & educ_OR <= upper_CI), FALSE, TRUE)
  ) %>% 
  knitr::kable(digits = 3)
```
educ is not a confounder since inferences for odds ratios of current smoking by sex was not changed by educ at the significance level 0.05.


####totchol
```{r}
sex_totchol <- 
  gee(cursmoke ~ sex + totchol, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

tibble(
    variable = c("sex2"),
    OR = 
      exp(coef(summary(sex))[2,1]),
    lower_CI  = 
      exp(coef(summary(sex))[2,1] - 1.96*(coef(summary(sex))[2,4])),
    upper_CI = 
      exp(coef(summary(sex))[2,1] + 1.96*(coef(summary(sex))[2,4])),
    totchol_OR =
      exp(coef(summary(sex_totchol))[2,1]),
    confounder =
      if_else((totchol_OR >= lower_CI & totchol_OR <= upper_CI), FALSE, TRUE)
  ) %>% 
  knitr::kable(digits = 3)
```
totchol is not a confounder since inferences for odds ratios of current smoking by sex was not changed by totchol at the significance level 0.05.

####hdlc #### confounder
```{r}
sex_hdlc <- 
  gee(cursmoke ~ sex + hdlc, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

tibble(
    variable = c("sex2"),
    OR = 
      exp(coef(summary(sex))[2,1]),
    lower_CI  = 
      exp(coef(summary(sex))[2,1] - 1.96*(coef(summary(sex))[2,4])),
    upper_CI = 
      exp(coef(summary(sex))[2,1] + 1.96*(coef(summary(sex))[2,4])),
    hdlc_OR =
      exp(coef(summary(sex_hdlc))[2,1]),
    confounder =
      if_else((hdlc_OR >= lower_CI & hdlc_OR <= upper_CI), FALSE, TRUE)
  ) %>% 
  knitr::kable(digits = 3)
```
hdlc is a confounder since inferences for odds ratios of current smoking by sex was changed by hdlc at the significance level 0.05.

####ldlc #### confounder
```{r}
sex_ldlc <- 
  gee(cursmoke ~ sex + ldlc, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

tibble(
    variable = c("sex2"),
    OR = 
      exp(coef(summary(sex))[2,1]),
    lower_CI  = 
      exp(coef(summary(sex))[2,1] - 1.96*(coef(summary(sex))[2,4])),
    upper_CI = 
      exp(coef(summary(sex))[2,1] + 1.96*(coef(summary(sex))[2,4])),
    ldlc_OR =
      exp(coef(summary(sex_ldlc))[2,1]),
    confounder =
      if_else((ldlc_OR >= lower_CI & ldlc_OR <= upper_CI), FALSE, TRUE)
  ) %>% 
  knitr::kable(digits = 3)
```
ldlc is a confounder since inferences for odds ratios of current smoking by sex was changed by ldlc at the significance level 0.05.


####bmi
```{r}
ggplot(frmgham, aes(x = bmi, y = cursmoke)) + 
  geom_jitter(height = 0.2, width = 3) +
  geom_smooth()

ggplot(frmgham, aes(x = sex, y = bmi)) + 
  geom_violin() +
  geom_smooth()
```
Since there is no difference in bmi by sex, bmi is not likely to be a confounder.

####glucose
```{r}
sex_glucose <- 
  gee(cursmoke ~ sex + glucose, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

tibble(
    variable = c("sex2"),
    OR = 
      exp(coef(summary(sex))[2,1]),
    lower_CI  = 
      exp(coef(summary(sex))[2,1] - 1.96*(coef(summary(sex))[2,4])),
    upper_CI = 
      exp(coef(summary(sex))[2,1] + 1.96*(coef(summary(sex))[2,4])),
    glucose_OR =
      exp(coef(summary(sex_glucose))[2,1]),
    confounder =
      if_else((glucose_OR >= lower_CI & glucose_OR <= upper_CI), FALSE, TRUE)
  ) %>% 
  knitr::kable(digits = 3)
```
glucose is not a confounder since inferences for odds ratios of current smoking by sex was not changed by glucose at the significance level 0.05.


####diabetes
```{r}
sex_diabetes <- 
  gee(cursmoke ~ sex + diabetes, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

tibble(
    variable = c("sex2"),
    OR = 
      exp(coef(summary(sex))[2,1]),
    lower_CI  = 
      exp(coef(summary(sex))[2,1] - 1.96*(coef(summary(sex))[2,4])),
    upper_CI = 
      exp(coef(summary(sex))[2,1] + 1.96*(coef(summary(sex))[2,4])),
    diabetes_OR =
      exp(coef(summary(sex_diabetes))[2,1]),
    confounder =
      if_else((diabetes_OR >= lower_CI & diabetes_OR <= upper_CI), FALSE, TRUE)
  ) %>% 
  knitr::kable(digits = 3)
```
diabetes is not a confounder since inferences for odds ratios of current smoking by sex was not changed by diabetes at the significance level 0.05.


####heartrte
```{r}
sex_heartrte <- 
  gee(cursmoke ~ sex + heartrte, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

tibble(
    variable = c("sex2"),
    OR = 
      exp(coef(summary(sex))[2,1]),
    lower_CI  = 
      exp(coef(summary(sex))[2,1] - 1.96*(coef(summary(sex))[2,4])),
    upper_CI = 
      exp(coef(summary(sex))[2,1] + 1.96*(coef(summary(sex))[2,4])),
    heartrte_OR =
      exp(coef(summary(sex_heartrte))[2,1]),
    confounder =
      if_else((heartrte_OR >= lower_CI & heartrte_OR <= upper_CI), FALSE, TRUE)
  ) %>% 
  knitr::kable(digits = 3)
```
heartrte is not a confounder since inferences for odds ratios of current smoking by sex was not changed by heartrte at the significance level 0.05.


####prevap
```{r}
sex_prevap <- 
  gee(cursmoke ~ sex + prevap, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

tibble(
    variable = c("sex2"),
    OR = 
      exp(coef(summary(sex))[2,1]),
    lower_CI  = 
      exp(coef(summary(sex))[2,1] - 1.96*(coef(summary(sex))[2,4])),
    upper_CI = 
      exp(coef(summary(sex))[2,1] + 1.96*(coef(summary(sex))[2,4])),
    prevap_OR =
      exp(coef(summary(sex_prevap))[2,1]),
    confounder =
      if_else((prevap_OR >= lower_CI & prevap_OR <= upper_CI), FALSE, TRUE)
  ) %>% 
  knitr::kable(digits = 3)
```
prevap is not a confounder since inferences for odds ratios of current smoking by sex was not changed by prevap at the significance level 0.05.

####prevchd
```{r}
sex_prevchd <- 
  gee(cursmoke ~ sex + prevchd, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

tibble(
    variable = c("sex2"),
    OR = 
      exp(coef(summary(sex))[2,1]),
    lower_CI  = 
      exp(coef(summary(sex))[2,1] - 1.96*(coef(summary(sex))[2,4])),
    upper_CI = 
      exp(coef(summary(sex))[2,1] + 1.96*(coef(summary(sex))[2,4])),
    prevchd_OR =
      exp(coef(summary(sex_prevchd))[2,1]),
    confounder =
      if_else((prevchd_OR >= lower_CI & prevchd_OR <= upper_CI), FALSE, TRUE)
  ) %>% 
  knitr::kable(digits = 3)
```
prevchd is not a confounder since inferences for odds ratios of current smoking by sex was not changed by prevchd at the significance level 0.05.

####prevmi
```{r}
sex_prevmi <- 
  gee(cursmoke ~ sex + prevmi, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

tibble(
    variable = c("sex2"),
    OR = 
      exp(coef(summary(sex))[2,1]),
    lower_CI  = 
      exp(coef(summary(sex))[2,1] - 1.96*(coef(summary(sex))[2,4])),
    upper_CI = 
      exp(coef(summary(sex))[2,1] + 1.96*(coef(summary(sex))[2,4])),
    prevmi_OR =
      exp(coef(summary(sex_prevmi))[2,1]),
    confounder =
      if_else((prevmi_OR >= lower_CI & prevmi_OR <= upper_CI), FALSE, TRUE)
  ) %>% 
  knitr::kable(digits = 3)
```
prevmi is not a confounder since inferences for odds ratios of current smoking by sex was not changed by prevmi at the significance level 0.05.

####prevstrk
```{r}
sex_prevstrk <- 
  gee(cursmoke ~ sex + prevstrk, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

tibble(
    variable = c("sex2"),
    OR = 
      exp(coef(summary(sex))[2,1]),
    lower_CI  = 
      exp(coef(summary(sex))[2,1] - 1.96*(coef(summary(sex))[2,4])),
    upper_CI = 
      exp(coef(summary(sex))[2,1] + 1.96*(coef(summary(sex))[2,4])),
    prevstrk_OR =
      exp(coef(summary(sex_prevstrk))[2,1]),
    confounder =
      if_else((prevstrk_OR >= lower_CI & prevstrk_OR <= upper_CI), FALSE, TRUE)
  ) %>% 
  knitr::kable(digits = 3)
```
prevstrk is not a confounder since inferences for odds ratios of current smoking by sex was not changed by prevstrk at the significance level 0.05.

####prevhyp 
```{r}
sex_prevhyp <- 
  gee(cursmoke ~ sex + prevhyp, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

tibble(
    variable = c("sex2"),
    OR = 
      exp(coef(summary(sex))[2,1]),
    lower_CI  = 
      exp(coef(summary(sex))[2,1] - 1.96*(coef(summary(sex))[2,4])),
    upper_CI = 
      exp(coef(summary(sex))[2,1] + 1.96*(coef(summary(sex))[2,4])),
    prevhyp_OR =
      exp(coef(summary(sex_prevhyp))[2,1]),
    confounder =
      if_else((prevhyp_OR >= lower_CI & prevhyp_OR <= upper_CI), FALSE, TRUE)
  ) %>% 
  knitr::kable(digits = 3)
```
prevhyp is not a confounder since inferences for odds ratios of current smoking by sex was not changed by prevhyp at the significance level 0.05.

(2) Is there a relationship between the number of cigarettes smoked per day and age?  Does this relationship differ by sex? 

While answering these questions, please account for any confounders that you have evidence may impact the relationship between age and sex with smoking.

```{r}
frmgham %>% 
  ggplot(., aes(x=age, y=cigpday)) +
    geom_jitter() + 
    geom_smooth(method = "loess") +
  ggtitle("Unadjusted relationship between the number of cigarettes smoked per day and age")
```

```{r}

```


```{r}
frmgham %>% 
  mutate(sex=ifelse(sex==1, "male","women")) %>% 
  ggplot(., aes(x=age, y=cigpday)) +
  geom_jitter() + 
  geom_smooth(method = "loess") +
  facet_grid(~sex)+
  ggtitle("Relationship between the number of cigarettes smoked per day and age by gender")
```




#2.Target question:

Next you are interested in the relationship between certain health outcomes and smoking status.  In particular you are interested in :


(1)The relationship between current smoking status and systolic blood pressure.


(2)The relationship between current smoking status and diastolic blood pressure.
```{r}
diabp <- 
  gee(cursmoke ~ diabp, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

diabp_sysbp <- 
  gee(cursmoke ~ diabp + sysbp, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

diabp_prevhyp <- 
  gee(cursmoke ~ diabp + prevhyp, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

diabp_hyperten <- 
  gee(cursmoke ~ diabp + hyperten, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))


tibble(
    variable = c("sysbp", "prevhyp", "hyperten"),
    OR = 
      exp(coef(summary(diabp))[2,1]),
    lower_CI  = 
      exp(coef(summary(diabp))[2,1] - 1.96*(coef(summary(diabp))[2,4])),
    upper_CI = 
      exp(coef(summary(diabp))[2,1] + 1.96*(coef(summary(diabp))[2,4])),
    conf_OR =
      c(exp(coef(summary(diabp_sysbp))[2,1]),
        exp(coef(summary(diabp_prevhyp))[2,1]),
        exp(coef(summary(diabp_hyperten))[2,1])),
    confounder =
      if_else((conf_OR >= lower_CI & conf_OR <= upper_CI), FALSE, TRUE)
  )

#confounders: sysbp, prevhyp, hyperten
```

(3)The relationship between current smoking status and serum total cholesterol.   Again, while answering these questions, please account for any confounders that you have evidence may impact these relationships. 
