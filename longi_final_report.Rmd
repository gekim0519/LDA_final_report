---
title: "logitudinal_final_proj"
author: "Lynette Pan"
date: "12/3/2018"
output: pdf_document
---

#Final Project: Smoking in the Framingham Heart Study


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(janitor)
library(mice)
library(gee)
library(lme4)

frmgham = 
  read.csv2("frmgham2.csv", sep = ",", na.strings=c("","NA")) %>% 
  clean_names() %>% select(cursmoke, everything()) %>% 
  mutate(sex = as.factor(sex),
         bpmeds = as.factor(bpmeds),
         educ = as.factor(educ),
         diabetes = as.factor(diabetes),
         prevap = as.factor(prevap),
         prevchd = as.factor(prevchd),
         prevmi = as.factor(prevmi),
         prevstrk = as.factor(prevstrk),
         prevhyp = as.factor(prevhyp),
         sysbp = as.numeric(levels(sysbp))[sysbp],
         diabp = as.numeric(as.character(diabp)),
         bmi = as.numeric(as.character(bmi))) %>% 
  as.tibble()

## created age category variable (age_ctg)
frmgham =
  frmgham %>% 
  mutate(
      age_ctg = case_when(
      age < 35 ~ "35-",  
      age %in% 35:44 ~ "35-44",
      age %in% 45:54 ~ "45-54",
      age %in% 55:64 ~ "55-64",
      age %in% 65:74 ~ "65-74",
      age >= 75 ~ "75+"
    ),
    age_ctg = fct_relevel(age_ctg, "35-")) 

## created sysbp category variable (sysbp_ctg)
### According to the new guideline from american heart association
### https://www.ahajournals.org/doi/10.1161/HYP.0000000000000065
frmgham =
  frmgham %>% 
  mutate(
      sysbp_ctg = case_when(
      sysbp < 120 ~ "normal",  
      (sysbp >= 120 & sysbp < 130) ~ "elevated",
      (sysbp >= 130 & sysbp < 140) ~ "stage1",
      (sysbp >= 140 & sysbp <= 180) ~ "stage2",
      sysbp > 180 ~ "crisis"
    ),
    sysbp_ctg = fct_relevel(sysbp_ctg, "normal")) 

## created sysbp category variable (diabp_ctg)
### According to the new guideline from american heart association
### https://www.ahajournals.org/doi/10.1161/HYP.0000000000000065
frmgham =
  frmgham %>% 
  mutate(
      diabp_ctg = case_when(
      diabp < 80 ~ "normal and elevated",  
      (diabp >= 80 & diabp < 90) ~ "stage1",
      (diabp >= 90 & diabp <= 120 ) ~ "stage2",
      diabp > 120 ~ "crisis"
      ),
    diabp_ctg = fct_relevel(diabp_ctg, "normal and elevated")) 


```

# Descriptive statistics
```{r}
#descriptive statistics for the data

summary(frmgham)
```



#missing values
```{r}
# frmgham %>% 
#   group_by(period) %>% 
#   summarize(sum_na_period = sum(is.na(period)))
# 
# d1 = frmgham %>% 
#   group_by(randid) %>% 
#   summarize(n = n())
# table(d1$n)
# # 447 patients have only one obs
# # 781 patients have only two obs
# # 3206 patients have all three obs
# 
# number.subjects <- 
#   frmgham  %>% 
#   select(randid) %>% 
#   distinct() %>% 
#   unlist() %>%
#   length()
# 
# number.subjects
# 
# # missing data pattern by variables
# 
# sort(sapply(frmgham, function(x) { sum(is.na(x)) }), decreasing=TRUE)

```

# Impute missing values using MICE package
```{r}
load("frmgham_complete.RData")
# # frmgham_temp <- mice(frmgham,m=1, method='cart', printFlag=FALSE,seed = 1)
# # frmgham
# # summary(frmgham_temp)
# # frmgham_complete <- complete(frmgham_temp)
# #save(frmgham_complete, file = "frmgham_complete.RData")
# frmgham_complete =
#   frmgham_complete %>% 
#   mutate(
#       age_ctg = case_when(
#       age < 35 ~ "35-",  
#       age %in% 35:44 ~ "35-44",
#       age %in% 45:54 ~ "45-54",
#       age %in% 55:64 ~ "55-64",
#       age %in% 65:74 ~ "65-74",
#       age >= 75 ~ "75+"
#     )) 
# 
# sort(sapply(frmgham_complete, function(x) { sum(is.na(x)) }), decreasing=TRUE)

```


* The output tells us that 2243 samples are complete, 7077 samples miss both hdlc and ldlc, 4 samples miss only the glucose value and so on.


* there are 447 patients who have only one obs; there are 781 patients who have only two obs and 3206 patients have all three obs. In total, there are 4434 patients in the study.

##1. Target question:
1) Is there a relationship between age and smoking status?  Does this relationship differ by sex? 

### cursmoke vs age_ctg without adjustment
```{r}
### cursmoke vs age_ctg : associated without adjustment 
frmgham %>% 
  select(randid, cursmoke, age_ctg) %>% 
  na.omit() %>% 
  group_by(age_ctg) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n()) %>% 
  ggplot(aes(x = age_ctg, y = p_cursmoke)) + 
  geom_bar(stat = "identity") +
  labs(title = "Relationship between categorized age and smoking status",
       x = "Age",
       y = "Probability of current smoking")
```


## Finding confounders -- confounder: hdlc, ldlc
```{r}
age <- 
  gee(cursmoke ~ age, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))

pot_conf <- names(frmgham)[-c(1:3, 5)]
pot_conf <-
  pot_conf[-c(grep("time", pot_conf))]

conf_det <- vector("list", length = length(pot_conf))
names(conf_det) <- pot_conf



for (conf in pot_conf) {

  data <- cbind(frmgham[,c("cursmoke", "age")], frmgham[,conf])
  try(fit_gee <- gee(cursmoke ~ .,
      data = data,
      id = frmgham$randid,
      family = binomial,
      corstr = ("unstructured")))

  result <- tibble(
    variable = c("age"),
    OR =
      exp(coef(summary(age))[2,1]),
    lower_CI  =
      exp(coef(summary(age))[2,1] - 1.96*(coef(summary(age))[2,4])),
    upper_CI =
      exp(coef(summary(age))[2,1] + 1.96*(coef(summary(age))[2,4])),
    potconf_OR =
      exp(coef(summary(fit_gee))[2,1]),
    confounder =
      if_else((potconf_OR >= lower_CI & potconf_OR <= upper_CI), FALSE, TRUE)
  )

  conf_det[[conf]] <- result
}

map(conf_det, knitr::kable, digits = 3)
```

## Finding modifier

```{r}
### by sex -- modified!
frmgham %>% 
  mutate(sex = ifelse(sex == 1, "male", "women")) %>%
  select(randid, cursmoke, age_ctg, sex) %>% 
  na.omit() %>% 
  group_by(age_ctg, sex) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n()) %>% 
  ggplot(aes(x = age_ctg, y = p_cursmoke, color = sex, group = sex)) + 
  geom_line() +
  geom_point() +
  labs(title = "Relationship between categorized age and smoking status by sex",
       x = "Age",
       y = "Probability of current smoking")

### by educ -- not modified except 35-

frmgham %>% 
  select(randid, cursmoke, age_ctg, educ) %>% 
  na.omit() %>% 
  group_by(age_ctg, educ) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n()) %>% 
  ggplot(aes(x = age_ctg, y = p_cursmoke, color = educ, group = educ)) + 
  geom_line() +
  geom_point() +
  labs(title = "Relationship between categorized age and smoking status by sex",
       x = "Age",
       y = "Probability of current smoking")

### by diabetes -- not modified 

frmgham %>% 
  select(randid, cursmoke, age_ctg, diabetes) %>% 
  na.omit() %>% 
  group_by(age_ctg, diabetes) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n()) %>% 
  ggplot(aes(x = age_ctg, y = p_cursmoke, color = diabetes, group = diabetes)) + 
  geom_line() +
  geom_point() +
  labs(title = "Relationship between categorized age and smoking status by sex",
       x = "Age",
       y = "Probability of current smoking")

### by prevap -- not modified 

frmgham %>% 
  select(randid, cursmoke, age_ctg, prevap) %>% 
  na.omit() %>% 
  group_by(age_ctg, prevap) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n()) %>% 
  ggplot(aes(x = age_ctg, y = p_cursmoke, color = prevap, group = prevap)) + 
  geom_line() +
  geom_point() +
  labs(title = "Relationship between categorized age and smoking status by sex",
       x = "Age",
       y = "Probability of current smoking")

### by prevchd -- not modified 

frmgham %>% 
  select(randid, cursmoke, age_ctg, prevchd) %>% 
  na.omit() %>% 
  group_by(age_ctg, prevchd) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n()) %>% 
  ggplot(aes(x = age_ctg, y = p_cursmoke, color = prevchd, group = prevchd)) + 
  geom_line() +
  geom_point() +
  labs(title = "Relationship between categorized age and smoking status by sex",
       x = "Age",
       y = "Probability of current smoking")

### by prevmi -- modified 

frmgham %>% 
  select(randid, cursmoke, age_ctg, prevmi) %>% 
  na.omit() %>% 
  group_by(age_ctg, prevmi) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n()) %>% 
  ggplot(aes(x = age_ctg, y = p_cursmoke, color = prevmi, group = prevmi)) + 
  geom_line() +
  geom_point() +
  labs(title = "Relationship between categorized age and smoking status by sex",
       x = "Age",
       y = "Probability of current smoking")

### by prevstrk -- slightly modified 

frmgham %>% 
  select(randid, cursmoke, age_ctg, prevstrk) %>% 
  na.omit() %>% 
  group_by(age_ctg, prevstrk) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n()) %>% 
  ggplot(aes(x = age_ctg, y = p_cursmoke, color = prevstrk, group = prevstrk)) + 
  geom_line() +
  geom_point() +
  labs(title = "Relationship between categorized age and smoking status by sex",
       x = "Age",
       y = "Probability of current smoking")

### by prevhyp -- slightly modified 

frmgham %>% 
  select(randid, cursmoke, age_ctg, prevhyp) %>% 
  na.omit() %>% 
  group_by(age_ctg, prevhyp) %>% 
  summarise(p_cursmoke = sum(cursmoke)/n()) %>% 
  ggplot(aes(x = age_ctg, y = p_cursmoke, color = prevhyp, group = prevhyp)) + 
  geom_line() +
  geom_point() +
  labs(title = "Relationship between categorized age and smoking status by sex",
       x = "Age",
       y = "Probability of current smoking")
```

## Fit model using glmer
```{r}
cursmoke_age <-
  glmer(cursmoke ~ age + sex + educ + hdlc + ldlc + prevmi + prevstrk + prevhyp + (1|randid), 
        data = frmgham, family = binomial, nAGQ = 0)

summary(cursmoke_age)
```


(2) Is there a relationship between the number of cigarettes smoked per day and age?  Does this relationship differ by sex? 

```{r}
frmgham_smoker =
  frmgham %>% filter(cursmoke == 1)
```

## cigpday summary
```{r}
frmgham_smoker %>% 
  group_by(randid) %>% 
  mutate(mean.cigpday = mean(cigpday)) %>% 
  ungroup() %>% 
  select(randid, mean.cigpday) %>% 
  distinct() %>% 
  ggplot(aes(x = mean.cigpday)) + 
  geom_histogram() +
  labs(x = "Average number of cigarrette smoked each day",
       y = "Count",
       title = "cigpday summary")
```


## Finding confounders
### age and cigpday -- confounder: hdlc, ldlc
```{r}
age <- 
  gee(cigpday ~ age, 
      data = frmgham_smoker, 
      id = randid, 
      family = poisson,
      corstr = ("unstructured"))

pot_conf <- names(frmgham_smoker)[-c(1:3, 8)]
pot_conf <-
  pot_conf[-c(grep("time", pot_conf))]
pot_conf <-
  pot_conf[-c(grep("age", pot_conf))]

conf_det <- vector("list", length = length(pot_conf))
names(conf_det) <- pot_conf



for (conf in pot_conf) {

  data <- cbind(frmgham_smoker[,c("cigpday", "age")], frmgham_smoker[,conf])
  try(fit_gee <- gee(cigpday ~ .,
      data = data,
      id = frmgham_smoker$randid,
      family = poisson,
      corstr = ("unstructured")))

  result <- tibble(
    variable = c("age"),
    RR =
      exp(coef(summary(age))[2,1]),
    lower_CI  =
      exp(coef(summary(age))[2,1] - 1.96*(coef(summary(age))[2,4])),
    upper_CI =
      exp(coef(summary(age))[2,1] + 1.96*(coef(summary(age))[2,4])),
    potconf_RR =
      exp(coef(summary(fit_gee))[2,1]),
    confounder =
      if_else((potconf_RR >= lower_CI & potconf_RR <= upper_CI), FALSE, TRUE)
  )

  conf_det[[conf]] <- result
}

map(conf_det, knitr::kable, digits = 3)
```


```{r}
# I will look into SYSBP DIABP TOTCHOL BMI DIABETES 
# based on https://tobaccocontrol.bmj.com/content/14/5/315
```



```{r}
frmgham %>% 
  mutate(sex=ifelse(sex==1, "male","women")) %>% 
  ggplot(., aes(x=age, y=cigpday)) +
  geom_jitter() + 
  geom_smooth(method = "loess") +
  facet_grid(~sex)+
  ggtitle("Relationship between the number of cigarettes smoked per day and age by gender")
```




#2.Target question:

Next you are interested in the relationship between certain health outcomes and smoking status. In particular you are interested in :


(1)The relationship between current smoking status and systolic blood pressure.
```{r}
frmgham %>% 
  ggplot(., aes(x=sysbp, y=cursmoke)) +
    geom_jitter() + 
    geom_smooth(method = "loess") + 
  ggtitle("Unadjusted relationship between current smoking status and diastolic blood pressure")

#https://www.ncbi.nlm.nih.gov/pubmed/7790985
#From the research paper above, diastolic blood pressure and hypertension are potential confounders.

#center the variables and find the confounder
frmgham$diabp_c = frmgham$diabp-mean(frmgham$diabp)
frmgham$sysbp_c = frmgham$sysbp-mean(frmgham$sysbp)

sysbp <- 
  glmer(cursmoke ~ sysbp_c + (1|randid), 
      data = frmgham, 
      family = binomial)

sysbp_diabp <- 
  glmer(cursmoke ~ sysbp_c + diabp_c + (1|randid), 
      data = frmgham, 
      family = binomial)

sysbp_prevhyp <- 
  glmer(cursmoke ~ sysbp_c + prevhyp + (1|randid), 
      data = frmgham, 
      family = binomial)

tibble(
    variable = c("diabp", "prevhyp"),
    OR = 
      exp(coef(summary(sysbp))[2,1]),
    lower_CI  = 
      exp(coef(summary(sysbp))[2,1] - 1.96*(coef(summary(sysbp))[2,4])),
    upper_CI = 
      exp(coef(summary(sysbp))[2,1] + 1.96*(coef(summary(sysbp))[2,4])),
    conf_OR =
      c(exp(coef(summary(sysbp_diabp))[2,1]),
        exp(coef(summary(sysbp_prevhyp))[2,1])),
    confounder =
      if_else((conf_OR >= lower_CI & conf_OR <= upper_CI), FALSE, TRUE)
  )

smoke_sysbp = glmer(cursmoke ~ sysbp_c +diabp_c+ prevhyp+(1|randid), 
      data = frmgham, 
      family = binomial,nAGQ = 0)
summary(smoke_sysbp)
```

From the table above, we found "diabp" and "prevhyp" are confounders. After adding the confounders, the final model is shown above. For a one-unit increase in the systolic blood pressure, the expected change in log odds of smoking status is -0.025344, adjusting for diastolic blood pressure and prevalent hypertensive.

(2)The relationship between current smoking status and diastolic blood pressure.
```{r}
frmgham %>% 
  ggplot(., aes(x=diabp, y=cursmoke)) +
    geom_jitter() + 
    geom_smooth(method = "loess") + 
  ggtitle("Unadjusted relationship between current smoking status and diastolic blood pressure")

#https://www.ncbi.nlm.nih.gov/pubmed/7790985
#From the research paper above, systolic blood pressure and hypertension are potential confounders.

#center the variables and find the confounder
diabp <- 
  glmer(cursmoke ~ diabp_c, 
      data = frmgham, 
      family = binomial)

diabp_sysbp <- 
  glmer(cursmoke ~ diabp_c + sysbp_c, 
      data = frmgham, 
      family = binomial)

diabp_prevhyp <- 
  glmer(cursmoke ~ diabp_c + prevhyp, 
      data = frmgham, 
      family = binomial)

tibble(
    variable = c("sysbp", "prevhyp"),
    OR = 
      exp(coef(summary(diabp))[2,1]),
    lower_CI  = 
      exp(coef(summary(diabp))[2,1] - 1.96*(coef(summary(diabp))[2,4])),
    upper_CI = 
      exp(coef(summary(diabp))[2,1] + 1.96*(coef(summary(diabp))[2,4])),
    conf_OR =
      c(exp(coef(summary(diabp_sysbp))[2,1]),
        exp(coef(summary(diabp_prevhyp))[2,1])),
    confounder =
      if_else((conf_OR >= lower_CI & conf_OR <= upper_CI), FALSE, TRUE)
  )

smoke_diabp = glmer(cursmoke ~ diabp_c + sysbp_c + prevhyp + (1|randid) , 
      data = frmgham, 
      family = binomial,nAGQ = 0)

summary(smoke_diabp)

#confounders: sysbp, prevhyp
```

From the table above, we found "sysbp" and "prevhyp" are confounders. After adding the confounders, the final model is shown above. For a one-unit increase in the diastolic blood pressure, the expected change in log odds of smoking status is 0.031559, adjusting for systolic blood pressure and prevalent hypertensive.

(3)The relationship between current smoking status and serum total cholesterol. Again, while answering these questions, please account for any confounders that you have evidence may impact these relationships. 


```{r}
frmgham %>% 
  ggplot(., aes(x=totchol, y=cursmoke)) +
    geom_jitter() + 
    geom_smooth(method = "loess") +ggtitle("Unadjusted relationship between current smoking status and serum total cholesterol")


#https://medlineplus.gov/cholesterollevelswhatyouneedtoknow.html
#categorized totchol based on link above

frmgham=frmgham %>% 
  mutate(totchol_ctg= ifelse(age<=19 & totchol<170,0,
                             ifelse(age>19&totchol %in% c(125, 200), 0,1)))
table(frmgham$totchol_ctg)
# 124 normal total chol 
# 11503 abnormal total chol
```

## Finding confounders


```{r}

frmgham= frmgham %>% 
  mutate(bmi=as.numeric(as.character(bmi))) %>% 
  mutate(bmi_cat = ifelse(bmi<18.5,0,ifelse(bmi %in% c(18.5,24.9), 1, ifelse(bmi %in% c(25, 29.9),2, 3))))

totchol <- 
  gee(cursmoke ~ totchol, 
      data = frmgham, 
      id = randid, 
      family = binomial,
      corstr = ("unstructured"))
pot_conf <- names(frmgham)[-c(1,2,4)]
pot_conf <- pot_conf[-c(grep("time", pot_conf), grep("death", pot_conf))]

conf_det <- vector("list", length = length(pot_conf))
names(conf_det) <- pot_conf



for (conf in pot_conf) {

 data <- cbind(frmgham[,c("cursmoke", "totchol")], frmgham[,conf])
 try(fit_gee <- gee(cursmoke ~ .,
     data = data,
     id = frmgham$randid,
     family = binomial,
     corstr = ("unstructured")))

 result <- tibble(
   variable = c("totchol"),
   OR =
     exp(coef(summary(totchol))[2,1]),
   lower_CI  =
     exp(coef(summary(totchol))[2,1] - 1.96*(coef(summary(totchol))[2,4])),
   upper_CI =
     exp(coef(summary(totchol))[2,1] + 1.96*(coef(summary(totchol))[2,4])),
   potconf_OR =
     exp(coef(summary(fit_gee))[2,1]),
   confounder =
     if_else((potconf_OR >= lower_CI & potconf_OR <= upper_CI), FALSE, TRUE)
 )

 conf_det[[conf]] <- result
}

map(conf_det, knitr::kable, digits = 3)
```


(1) age


```{r}


frmgham%>% 
  select(randid,totchol_ctg, age_ctg, cursmoke) %>% 
  na.omit() %>% 
  group_by(totchol_ctg,age_ctg) %>% 
  dplyr::summarise(percent.currentsmoke = sum(cursmoke)/n(),
                   n = n())
```

(2)hdlc

```{r}
frmgham%>% 
  select(randid,totchol_ctg, hdlc, cursmoke) %>% 
  mutate(hdlc_ctg = cut(hdlc,breaks=c(-Inf, 40, 60, Inf), labels = c("Low", "Normal","Good"))) %>% 
  na.omit() %>% 
  group_by(totchol_ctg,hdlc_ctg) %>% 
  dplyr::summarise(percent.currentsmoke = sum(cursmoke)/n(),
                   n = n())
```


(3)ldlc

```{r}
frmgham%>% 
  select(randid,totchol_ctg, ldlc, cursmoke) %>% 
  mutate(ldlc_ctg = ifelse(ldlc>=130, "High","Ideal")) %>% 
  na.omit() %>% 
  group_by(totchol_ctg,ldlc_ctg) %>% 
  dplyr::summarise(percent.currentsmoke = sum(cursmoke)/n(),
                   n = n())
```




```{r}
#lorelogram 

lorelogram <- function(id, time, y, title){
  data <- data_frame(id,time,y)
  
  #function that innumerates all combinations of a given time
  #and all futures times for an individual and then
  #returns a dataframe of time differences and results at both time points
  calc_time_deltas <- function(ind_data){
    results <- expand.grid(ind_data$time,ind_data$time) %>%
      rename(time1 = Var1, time2 = Var2) %>%  #rename columns to meaningful stuff
      right_join(ind_data[,c("time", "y")], by = c("time1" = "time")) %>%
      rename(y1 = y) %>%  #add results for time1 from the full data
      right_join(ind_data[,c("time", "y")], by = c("time2" = "time")) %>%
      rename(y2 = y) %>%  #add results for time2 from the full data.
      mutate(time_diff = time1 - time2, id = ind_data$id[1]) %>% #find difference in times
      filter(time_diff > 0) #cleanup output.
  }
  
  Z <- data %>%
    group_by(id) %>% #grab an individuals data in isolation
    do(calc_time_deltas(.)) #run the immumeration function
  
  #Predict past outcomes from future by utilizing time differences
  outcome_model <- glm(y1 ~ y2:factor(time_diff), data=Z, family=binomial)
  
  #grab the parameter estimates (ignoring intercept)
  LOR_estimates <- data_frame(
    time_diff = sort(unique(Z$time_diff)),
    point_est = summary(outcome_model)$coef[-1,1],
    std_err = summary(outcome_model)$coef[-1,2] ) %>%
    mutate(lower_bound = point_est - 1.96*std_err,
           upper_bound = point_est + 1.96*std_err)
  
  #plot it
  ggplot(LOR_estimates, aes(x = time_diff)) +
    geom_ribbon(aes(ymin = lower_bound, ymax = upper_bound, fill = "95 % CI"),
                alpha = 0.5) +
    geom_line(aes(y = point_est, color = "point estimate")) +
    scale_colour_manual("",values="black")+
    scale_fill_manual("",values="steelblue") +
    labs(x = "time change", y = "Log Odds Ratio", title = title)
}
  
 frmgha.remove.na <- frmgham %>% 
   na.omit() 
# 
   lorelogram(id = frmgha.remove.na$randid, 
              time = frmgha.remove.na$period,
              y = frmgha.remove.na$cursmoke,
              title = 'Lorelogram')  

```

